---

**系统信息采集与监控平台 (模块化增强版) - 开发需求文档**

**文档版本:** 1.0
**创建日期:** 2025-05-08

**1. 项目概述**

本项目旨在构建一个高性能、高可扩展性的系统信息采集与监控平台，核心由 **Hub** 和 **Agent** 两部分组成。**Agent** 采用先进的**插件化设计**，支持在运行时**动态加载、卸载和管理功能模块**，例如各种系统监控和性能测试任务。Agent 通过稳定的 **TCP 长连接**与 Hub 进行**双向通信**，高效地向 Hub 上报丰富的系统信息和任务执行结果，并响应 Hub 下发的各种控制指令和任务请求。**Hub** 作为平台的中心节点，负责**接收、存储和集中管理**来自所有 Agent 的数据，协调和分配 Agent 任务，并通过强大的 **WebSocket 接口**为前端应用提供**实时、高效的数据交互能力**。

**2. 系统架构**

```
+-----------------+      TCP      +---------------------+      SQLite3     +-----------------+      WebSocket     +-----------------+
|     Agent (Go)    | <---------> |    Hub (Node.js TS) | <---------> |     Database      | <---------> |     Frontend      |
+-----------------+              +---------------------+              +-----------------+              +-----------------+
| - 系统信息采集  |              | - TCP 监听           |              | - 系统信息存储  |              | - 数据展示       |
| - 插件化任务    |              | - 密钥鉴权           |              | - Agent 信息管理 |              | - 实时监控       |
| - TCP 长连接     |              | - 任务管理           |              | - 任务定义存储  |              +-----------------+
| - 数据序列化    |              | - 数据反序列化       |              |                |
| - 日志输出       |              | - 日志输出           |              |
| - UUID 管理      |              | - 数据存储           |              |
| - 密钥管理       |              | - WebSocket 服务     |              |
| - 重试与容错     |              | - 异常处理           |              |
+-----------------+              +---------------------+              |
                                                                   |
                                                                   +-----------------+
```

**2.1. 技术选型**

*   **Hub:** Node.js (TypeScript) + SQLite3 + WebSocket
*   **Agent:** Go (Golang) + Plugin Support
*   **通信协议:** TCP (自定义协议，长连接，双向通信)
*   **日志:** Text 格式 (可扩展为结构化日志)
*   **鉴权:** 密钥鉴权 (共享密钥，可升级为非对称加密)
*   **唯一标识:** UUID (Agent 唯一标识)

**2.2. 运行环境要求**

*   **Agent:**
    *   操作系统: Windows, Linux (x86_64)
    *   虚拟化环境: LXC, KVM 或物理机
    *   最低资源: 1 核 CPU, 256MB 内存, 1GB 硬盘
*   **Hub:**
    *   操作系统: Windows, Linux (x86_64)
    *   虚拟化环境: KVM 或物理机
    *   资源: 推荐 2 核 CPU, 1GB 内存, 5GB 硬盘 (根据 Agent 数量调整)

**3. 功能需求**

**3.1. Agent 功能**

*   **系统信息采集:**
    *   采集并上报以下实时系统信息：
        *   实时网络接口流量 (bytes/sec 或 bits/sec)
        *   系统运行时间 (uptime)
        *   CPU 总用量 (%)
        *   CPU 型号
        *   CPU 核心数
        *   总物理内存大小 (bytes)
        *   已用物理内存用量 (bytes)
        *   总硬盘大小 (bytes)
        *   已用硬盘用量 (bytes)
        *   总 Swap 大小 (bytes)
        *   已用 Swap 用量 (bytes)
        *   上下行流量分别总用量 (累计 bytes)
        *   当前的 TCP 连接数
        *   当前的 UDP 连接数
        *   系统 UUID (唯一标识 Agent)
        *   IPv4 地址列表
        *   IPv6 地址列表
    *   可配置的采集频率。
*   **插件化任务执行:**
    *   支持动态加载、卸载和管理 Go 语言编写的任务插件。
    *   插件应实现预定义的任务接口。
    *   可根据 Hub 下发的指令启动、停止任务插件。
    *   收集任务插件的执行结果。
*   **TCP 长连接通信:**
    *   建立并维护与 Hub 的持久化 TCP 长连接。
    *   实现自定义双向通信协议，支持数据发送和接收。
    *   实现心跳机制，定期向 Hub 发送心跳包，保持连接活跃。
    *   实现自动重连机制，在连接断开后尝试重新连接 Hub。
*   **数据序列化:**
    *   将采集的系统信息和任务结果序列化为适合通过 TCP 发送的格式 (例如 Protocol Buffers, MessagePack)。
*   **日志记录:**
    *   记录 Agent 的运行状态、错误、任务执行情况等信息到本地文本文件。
*   **UUID 管理:**
    *   生成并持久化存储 Agent 的唯一 UUID，用于 Hub 识别 Agent。
*   **密钥管理与鉴权:**
    *   存储和管理与 Hub 通信使用的共享密钥。
    *   在建立 TCP 连接时进行密钥鉴权。
*   **重试与容错:**
    *   实现数据发送失败、任务执行失败等的重试机制。
    *   优雅处理异常情况，避免 Agent 崩溃。

**3.2. Hub 功能**

*   **TCP 监听与连接管理:**
    *   监听指定端口，接受 Agent 的 TCP 连接。
    *   维护 Agent 的 TCP 长连接列表。
    *   处理 Agent 连接的断开事件，清理相关资源。
*   **密钥鉴权:**
    *   对 Agent 发起的 TCP 连接进行密钥鉴权，只接受合法的连接。
*   **数据接收与反序列化:**
    *   接收 Agent 发送的 TCP 数据。
    *   根据自定义协议反序列化数据。
*   **数据存储:**
    *   将 Agent 上报的系统信息存储到 SQLite3 数据库。
    *   存储 Agent 的基本信息 (UUID, IP, 连接状态等)。
    *   存储任务的定义和配置。
*   **任务管理:**
    *   接收前端或其他来源的任务指令。
    *   根据指令向指定的 Agent 下发任务请求（通过 TCP 长连接）。
    *   管理任务的生命周期（启动、停止、配置更新）。
*   **WebSocket 服务:**
    *   创建 WebSocket 服务器，接受前端连接。
    *   对 WebSocket 连接进行身份验证 (如果需要，例如基于 Session 或 Token)。
    *   实时推送 Agent 上报的系统信息和任务结果给连接的前端客户端。
    *   接收前端通过 WebSocket 发送的指令（例如查询历史数据、下发任务）。
*   **日志记录:**
    *   记录 Hub 的运行状态、错误、Agent 连接情况等信息。
*   **异常处理:**
    *   健壮地处理各种异常，如网络中断、数据解析错误、数据库操作失败等。

**3.3. 前端功能 (与 Hub 的 WebSocket 接口交互)**

*   连接 Hub 的 WebSocket 服务。
*   接收并实时展示 Agent 上报的系统信息。
*   展示 Agent 列表和连接状态。
*   根据 Agent UUID 查看详细的系统信息和历史数据。
*   通过 WebSocket 发送指令给 Hub，以下发或管理 Agent 任务。
*   可视化展示监控数据（图表等）。

**4. 非功能性需求**

*   **性能:**
    *   Agent 应具备较低的资源消耗，满足最低配置要求。
    *   Hub 应能够处理并发的 Agent 连接和前端 WebSocket 连接，具备良好的吞吐量和响应速度。
*   **可靠性:**
    *   Agent 应具备自动重连、数据发送重试等机制，保证数据不丢失。
    *   Hub 应具备异常处理和错误恢复能力。
*   **可扩展性:**
    *   Agent 插件化设计应易于扩展新的监控任务。
    *   系统架构应支持未来 Hub 的横向扩展 (负载均衡、服务发现)。
*   **安全性:**
    *   Agent 与 Hub 之间通过密钥进行身份鉴权。
    *   可考虑对传输数据进行加密。
    *   WebSocket 连接可考虑使用 WSS (WebSocket Secure)。
*   **可维护性:**
    *   代码结构清晰，模块化设计。
    *   提供详细的文档 (API 文档、开发指南)。
    *   完善的日志记录，便于故障排查。
*   **部署:**
    *   Agent 应易于打包和部署为独立的二进制文件。
    *   Hub 应易于部署和配置。

**5. 详细设计 (高层)**

**5.1. Agent (Go)**

*   **模块划分:**
    *   `config`: 配置加载与解析。
    *   `logger`: 日志输出。
    *   `uuidgen`: UUID 生成与管理。
    *   `auth`: 密钥管理与鉴权逻辑。
    *   `protocol`: TCP 通信协议的实现。
    *   `network`: TCP 连接管理 (心跳、重连)。
    *   `systeminfo`: 系统信息采集模块，调用跨平台库。
    *   `pluginmanager`: 插件加载、管理、执行。
    *   `task`: 任务接口定义及通用任务逻辑。
    *   `agent`: Agent 主体，协调各模块。
*   **插件接口:**
    *   定义清晰的 Go 接口，包含 `Init()`, `Run()`, `Stop()`, `Report()`, `Name()` 等方法。
*   **通信协议:**
    *   设计消息头部，包含消息类型、数据长度等信息。
    *   定义不同的消息类型，如系统信息上报、任务结果上报、心跳、Hub 指令等。
    *   数据载荷使用序列化格式 (e.g., Protocol Buffers)。

**5.2. Hub (Node.js TS)**

*   **模块划分:**
    *   `config`: 配置加载与解析。
    *   `logger`: 日志输出。
    *   `database`: SQLite3 数据库操作封装。
    *   `auth`: 密钥鉴权逻辑。
    *   `protocol`: TCP 通信协议的反序列化。
    *   `tcp server`: TCP 监听与连接管理。
    *   `websocket server`: WebSocket 监听与连接管理。
    *   `agentmanager`: Agent 连接状态和信息的管理。
    *   `taskmanager`: 任务的接收、分发和状态管理。
    *   `dataprocesor`: 处理接收到的 Agent 数据，存储到数据库。
    *   `hub`: Hub 主体，协调各模块。
*   **WebSocket API:**
    *   定义清晰的 WebSocket 消息格式 (推荐 JSON)。
    *   定义不同的消息类型，如实时数据推送、历史数据请求、任务下发请求、任务状态查询等。
    *   定义错误码和响应格式。


**6. 文档与交付物**

*   **代码仓库:** Agent (Go) 和 Hub (Node.js) 独立代码仓库。
*   **README.md:** 项目介绍、快速启动指南、配置说明。
*   **docs/:**
    *   `architecture.md`: 详细系统架构文档。
    *   `protocol.md`: TCP 通信协议详细定义。
    *   `agent_dev_guide.md`: Agent 开发指南，包括插件开发规范。
    *   `hub_dev_guide.md`: Hub 开发指南。
    *   `websocket_api.md`: WebSocket API 详细文档。
*   **可执行文件:** Agent 的跨平台可执行文件。
*   **部署脚本/配置:** 用于部署 Agent 和 Hub 的脚本或配置。

---
